Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.isValidEditor = isValidEditor;
exports.focusEditor = focusEditor;
exports.replaceTag = replaceTag;
exports.replaceTags = replaceTags;
exports.formatType = formatType;
exports.prepareType = prepareType;
exports.prepareInlineDocs = prepareInlineDocs;
exports.buildDisplayText = buildDisplayText;
exports.buildSnippet = buildSnippet;
exports.extractParams = extractParams;
exports.formatTypeCompletion = formatTypeCompletion;
exports.disposeAll = disposeAll;
exports.openFileAndGoToPosition = openFileAndGoToPosition;
exports.openFileAndGoTo = openFileAndGoTo;
exports.updateTernFile = updateTernFile;
exports.writeFile = writeFile;
exports.isDirectory = isDirectory;
exports.fileExists = fileExists;
exports.getFileContent = getFileContent;
exports.readFile = readFile;
exports.markDefinitionBufferRange = markDefinitionBufferRange;
exports.getPackagePath = getPackagePath;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atomTernjsManager = require('./atom-ternjs-manager');

var _atomTernjsManager2 = _interopRequireDefault(_atomTernjsManager);

var _atomTernjsPackageConfig = require('./atom-ternjs-package-config');

var _atomTernjsPackageConfig2 = _interopRequireDefault(_atomTernjsPackageConfig);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _servicesNavigation = require('./services/navigation');

var _servicesNavigation2 = _interopRequireDefault(_servicesNavigation);

'use babel';

var tags = {

  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;'
};

var grammars = ['JavaScript', 'JavaScript (JSX)', 'Babel ES6 JavaScript', 'Vue Component'];

function isValidEditor(editor) {

  var isTextEditor = atom.workspace.isTextEditor(editor);

  if (!isTextEditor || editor.isMini()) {

    return false;
  }

  var grammar = editor.getGrammar();

  if (!grammars.includes(grammar.name)) {

    return false;
  }

  return true;
}

function focusEditor() {

  var editor = atom.workspace.getActiveTextEditor();

  if (!editor) {

    return;
  }

  var view = atom.views.getView(editor);

  view && view.focus && view.focus();
}

function replaceTag(tag) {

  return tags[tag];
}

function replaceTags(str) {

  if (!str) {

    return '';
  }

  return str.replace(/[&<>]/g, replaceTag);
}

function formatType(data) {

  if (!data.type) {

    return '';
  }

  data.type = data.type.replace(/->/g, ':').replace('<top>', 'window');

  if (!data.exprName) {

    return data.type;
  }

  data.type = data.type.replace(/^fn/, data.exprName);

  return data.type;
}

function prepareType(data) {

  if (!data.type) {

    return;
  }

  return data.type.replace(/->/g, ':').replace('<top>', 'window');
}

function prepareInlineDocs(data) {

  return data.replace(/@param/, '<span class="doc-param-first">@param</span>').replace(/@param/g, '<span class="text-info doc-param">@param</span>').replace(/@return/, '<span class="text-info doc-return">@return</span>');
}

function buildDisplayText(params, name) {

  if (params.length === 0) {

    return name + '()';
  }

  var suggestionParams = params.map(function (param) {

    param = param.replace('}', '\\}');
    param = param.replace(/'"/g, '');

    return param;
  });

  return name + '(' + suggestionParams.join(',') + ')';
}

function buildSnippet(params, name) {

  var suggestionParams = params.map(function (param, i) {

    param = param.replace('}', '\\}');

    return '${' + (i + 1) + ':' + param + '}';
  });

  return name + '(' + suggestionParams.join(',') + ')';
}

function extractParams(type) {

  if (!type || type.startsWith('fn()')) {

    return [];
  }

  var params = [];
  var start = type.indexOf('(') + 1;
  var inside = 0;

  for (var i = start; i < type.length; i++) {

    if (type[i] === ':' && inside === -1) {

      params.push(type.substring(start, i - 2));

      break;
    }

    if (i === type.length - 1) {

      var param = type.substring(start, i);

      if (param.length) {

        params.push(param);
      }

      break;
    }

    if (type[i] === ',' && inside === 0) {

      params.push(type.substring(start, i));
      start = i + 1;

      continue;
    }

    if (type[i].match(/[{\[\(]/)) {

      inside++;

      continue;
    }

    if (type[i].match(/[}\]\)]/)) {

      inside--;
    }
  }

  return params;
}

function formatTypeCompletion(obj, isProperty, isObjectKey, isInFunDef) {

  if (obj.isKeyword) {

    obj._typeSelf = 'keyword';
  }

  if (obj.type === 'string') {

    obj.name = obj.name ? obj.name.replace(/(^"|"$)/g, '') : null;
  } else {

    obj.name = obj.name ? obj.name.replace(/["']/g, '') : null;
  }

  obj.name = obj.name ? obj.name.replace(/^..?\//, '') : null;

  if (!obj.type) {

    obj._displayText = obj.name;
    obj._snippet = obj.name;

    return obj;
  }

  if (!obj.type.startsWith('fn')) {

    if (isProperty) {

      obj._typeSelf = 'property';
    } else {

      obj._typeSelf = 'variable';
    }
  }

  obj.type = obj.rightLabel = prepareType(obj);

  if (obj.type.replace(/fn\(.+\)/, '').length === 0) {

    obj.leftLabel = '';
  } else {

    if (obj.type.indexOf('fn') === -1) {

      obj.leftLabel = obj.type;
    } else {

      obj.leftLabel = obj.type.replace(/fn\(.{0,}\)/, '').replace(' : ', '');
    }
  }

  if (obj.rightLabel.startsWith('fn')) {

    var params = extractParams(obj.rightLabel);
    var editor = atom.workspace.getActiveTextEditor();
    var cursor = editor.getLastCursor();
    var bufferPosition = cursor.getBufferPosition();
    var bufferPositionFollowing = [bufferPosition.row, bufferPosition.column + 1];
    var charFollowing = editor.getTextInBufferRange([bufferPosition, bufferPositionFollowing]);
    var shouldAddParenthesesToSnippet = charFollowing !== '(';

    if (_atomTernjsPackageConfig2['default'].options.useSnippets || _atomTernjsPackageConfig2['default'].options.useSnippetsAndFunction) {

      if (!isInFunDef) {

        if (params.length === 0) {

          obj._snippet = '' + obj.name + (shouldAddParenthesesToSnippet ? '()' : '');
        } else {

          obj._snippet = buildSnippet(params, obj.name);
        }
      }

      obj._hasParams = params.length ? true : false;
    } else {

      if (!isInFunDef) {

        obj._snippet = params.length ? obj.name + '(${' + 0 + ':${}})' : '' + obj.name + (shouldAddParenthesesToSnippet ? '()' : '');
      }

      obj._displayText = buildDisplayText(params, obj.name);
    }

    obj._typeSelf = 'function';
  }

  if (obj.name) {

    if (obj.leftLabel === obj.name) {

      obj.leftLabel = null;
      obj.rightLabel = null;
    }
  }

  if (obj.leftLabel === obj.rightLabel) {

    obj.rightLabel = null;
  }

  return obj;
}

function disposeAll(disposables) {

  disposables.forEach(function (disposable) {
    return disposable.dispose();
  });
}

function openFileAndGoToPosition(position, file) {

  atom.workspace.open(file).then(function (textEditor) {

    var cursor = textEditor.getLastCursor();

    if (!cursor) {

      return;
    }

    cursor.setBufferPosition(position);
  });
}

function openFileAndGoTo(start, file) {

  atom.workspace.open(file).then(function (textEditor) {

    var buffer = textEditor.getBuffer();
    var cursor = textEditor.getLastCursor();

    if (!buffer || !cursor) {

      return;
    }

    var bufferPosition = buffer.positionForCharacterIndex(start);

    cursor.setBufferPosition(buffer.positionForCharacterIndex(start));

    _servicesNavigation2['default'].append(textEditor, buffer, bufferPosition);

    markDefinitionBufferRange(cursor, textEditor);
  });
}

function updateTernFile(content) {

  var projectRoot = _atomTernjsManager2['default'].server && _atomTernjsManager2['default'].server.projectDir;

  if (!projectRoot) {

    return;
  }

  writeFile(_path2['default'].resolve(__dirname, projectRoot + '/.tern-project'), content);
}

function writeFile(filePath, content) {

  _fs2['default'].writeFile(filePath, content, function (error) {

    atom.workspace.open(filePath);

    if (!error) {

      var server = _atomTernjsManager2['default'].server;
      server && server.restart();

      return;
    }

    var message = 'Could not create/update .tern-project file. Use the README to manually create a .tern-project file.';

    atom.notifications.addInfo(message, {

      dismissable: true
    });
  });
}

function isDirectory(dir) {

  try {

    return _fs2['default'].statSync(dir).isDirectory();
  } catch (error) {

    return false;
  }
}

function fileExists(path) {

  try {

    _fs2['default'].accessSync(path, _fs2['default'].F_OK, function (error) {

      console.error(error);
    });
  } catch (error) {

    return false;
  }
}

function getFileContent(filePath, root) {

  var _filePath = root + filePath;
  var resolvedPath = _path2['default'].resolve(__dirname, _filePath);

  if (fileExists(resolvedPath) !== undefined) {

    return false;
  }

  return readFile(resolvedPath);
}

function readFile(path) {

  try {

    return _fs2['default'].readFileSync(path, 'utf8');
  } catch (err) {

    return undefined;
  }
}

function markDefinitionBufferRange(cursor, editor) {

  var range = cursor.getCurrentWordBufferRange();
  var marker = editor.markBufferRange(range, { invalidate: 'touch' });

  var decoration = editor.decorateMarker(marker, {

    type: 'highlight',
    'class': 'atom-ternjs-definition-marker',
    invalidate: 'touch'
  });

  if (!decoration) {

    return;
  }

  setTimeout(function () {

    decoration.setProperties({

      type: 'highlight',
      'class': 'atom-ternjs-definition-marker active',
      invalidate: 'touch'
    });
  }, 1);

  setTimeout(function () {

    decoration.setProperties({

      type: 'highlight',
      'class': 'atom-ternjs-definition-marker',
      invalidate: 'touch'
    });
  }, 1501);

  setTimeout(function () {

    marker.destroy();
  }, 2500);
}

function getPackagePath() {

  var packagPath = atom.packages.resolvePackagePath('atom-ternjs');

  return packagPath;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2RvdXRoZXJkdi8uYXRvbS9wYWNrYWdlcy9hdG9tLXRlcm5qcy9saWIvYXRvbS10ZXJuanMtaGVscGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7aUNBRW9CLHVCQUF1Qjs7Ozt1Q0FDakIsOEJBQThCOzs7O29CQUN2QyxNQUFNOzs7O2tCQUNSLElBQUk7Ozs7a0NBQ0ksdUJBQXVCOzs7O0FBTjlDLFdBQVcsQ0FBQzs7QUFRWixJQUFNLElBQUksR0FBRzs7QUFFWCxLQUFHLEVBQUUsT0FBTztBQUNaLEtBQUcsRUFBRSxNQUFNO0FBQ1gsS0FBRyxFQUFFLE1BQU07Q0FDWixDQUFDOztBQUVGLElBQU0sUUFBUSxHQUFHLENBRWYsWUFBWSxFQUNaLGtCQUFrQixFQUNsQixzQkFBc0IsRUFDdEIsZUFBZSxDQUNoQixDQUFDOztBQUVLLFNBQVMsYUFBYSxDQUFDLE1BQU0sRUFBRTs7QUFFcEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7O0FBRXpELE1BQUksQ0FBQyxZQUFZLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFOztBQUVwQyxXQUFPLEtBQUssQ0FBQztHQUNkOztBQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQzs7QUFFcEMsTUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFOztBQUVwQyxXQUFPLEtBQUssQ0FBQztHQUNkOztBQUVELFNBQU8sSUFBSSxDQUFDO0NBQ2I7O0FBRU0sU0FBUyxXQUFXLEdBQUc7O0FBRTVCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsQ0FBQzs7QUFFcEQsTUFBSSxDQUFDLE1BQU0sRUFBRTs7QUFFWCxXQUFPO0dBQ1I7O0FBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxD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SyxHQUFHLE1BQU0sQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO0FBQ2pELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLEVBQUMsVUFBVSxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUM7O0FBRXBFLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFOztBQUUvQyxRQUFJLEVBQUUsV0FBVztBQUNqQixhQUFPLCtCQUErQjtBQUN0QyxjQUFVLEVBQUUsT0FBTztHQUNwQixDQUFDLENBQUM7O0FBRUgsTUFBSSxDQUFDLFVBQVUsRUFBRTs7QUFFZixXQUFPO0dBQ1I7O0FBRUQsWUFBVSxDQUFDLFlBQU07O0FBRWYsY0FBVSxDQUFDLGFBQWEsQ0FBQzs7QUFFdkIsVUFBSSxFQUFFLFdBQVc7QUFDakIsZUFBTyxzQ0FBc0M7QUFDN0MsZ0JBQVUsRUFBRSxPQUFPO0tBQ3BCLENBQUMsQ0FBQztHQUVKLEVBQUUsQ0FBQyxDQUFDLENBQUM7O0FBRU4sWUFBVSxDQUFDLFlBQU07O0FBRWYsY0FBVSxDQUFDLGFBQWEsQ0FBQzs7QUFFdkIsVUFBSSxFQUFFLFdBQVc7QUFDakIsZUFBTywrQkFBK0I7QUFDdEMsZ0JBQVUsRUFBRSxPQUFPO0tBQ3BCLENBQUMsQ0FBQztHQUVKLEVBQUUsSUFBSSxDQUFDLENBQUM7O0FBRVQsWUFBVSxDQUFDLFlBQU07O0FBRWYsVUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0dBRWxCLEVBQUUsSUFBSSxDQUFDLENBQUM7Q0FDVjs7QUFFTSxTQUFTLGNBQWMsR0FBRzs7QUFFL0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFbkUsU0FBTyxVQUFVLENBQUM7Q0FDbkIiLCJmaWxlIjoiL2hvbWUvZG91dGhlcmR2Ly5hdG9tL3BhY2thZ2VzL2F0b20tdGVybmpzL2xpYi9hdG9tLXRlcm5qcy1oZWxwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IG1hbmFnZXIgZnJvbSAnLi9hdG9tLXRlcm5qcy1tYW5hZ2VyJztcbmltcG9ydCBwYWNrYWdlQ29uZmlnIGZyb20gJy4vYXRvbS10ZXJuanMtcGFja2FnZS1jb25maWcnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IG5hdmlnYXRpb24gZnJvbSAnLi9zZXJ2aWNlcy9uYXZpZ2F0aW9uJztcblxuY29uc3QgdGFncyA9IHtcblxuICAnJic6ICcmYW1wOycsXG4gICc8JzogJyZsdDsnLFxuICAnPic6ICcmZ3Q7J1xufTtcblxuY29uc3QgZ3JhbW1hcnMgPSBbXG5cbiAgJ0phdmFTY3JpcHQnLFxuICAnSmF2YVNjcmlwdCAoSlNYKScsXG4gICdCYWJlbCBFUzYgSmF2YVNjcmlwdCcsXG4gICdWdWUgQ29tcG9uZW50J1xuXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzVmFsaWRFZGl0b3IoZWRpdG9yKSB7XG5cbiAgY29uc3QgaXNUZXh0RWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuaXNUZXh0RWRpdG9yKGVkaXRvcik7XG5cbiAgaWYgKCFpc1RleHRFZGl0b3IgfHwgZWRpdG9yLmlzTWluaSgpKSB7XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBjb25zdCBncmFtbWFyID0gZWRpdG9yLmdldEdyYW1tYXIoKTtcblxuICBpZiAoIWdyYW1tYXJzLmluY2x1ZGVzKGdyYW1tYXIubmFtZSkpIHtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9jdXNFZGl0b3IoKSB7XG5cbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG4gIGlmICghZWRpdG9yKSB7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB2aWV3ID0gYXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvcik7XG5cbiAgdmlldyAmJiB2aWV3LmZvY3VzICYmIHZpZXcuZm9jdXMoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VUYWcodGFnKSB7XG5cbiAgcmV0dXJuIHRhZ3NbdGFnXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VUYWdzKHN0cikge1xuXG4gIGlmICghc3RyKSB7XG5cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICByZXR1cm4gc3RyLnJlcGxhY2UoL1smPD5dL2csIHJlcGxhY2VUYWcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0VHlwZShkYXRhKSB7XG5cbiAgaWYgKCFkYXRhLnR5cGUpIHtcblxuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGRhdGEudHlwZSA9IGRhdGEudHlwZS5yZXBsYWNlKC8tPi9nLCAnOicpLnJlcGxhY2UoJzx0b3A+JywgJ3dpbmRvdycpO1xuXG4gIGlmICghZGF0YS5leHByTmFtZSkge1xuXG4gICAgcmV0dXJuIGRhdGEudHlwZTtcbiAgfVxuXG4gIGRhdGEudHlwZSA9IGRhdGEudHlwZS5yZXBsYWNlKC9eZm4vLCBkYXRhLmV4cHJOYW1lKTtcblxuICByZXR1cm4gZGF0YS50eXBlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlcGFyZVR5cGUoZGF0YSkge1xuXG4gIGlmICghZGF0YS50eXBlKSB7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICByZXR1cm4gZGF0YS50eXBlLnJlcGxhY2UoLy0+L2csICc6JykucmVwbGFjZSgnPHRvcD4nLCAnd2luZG93Jyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwYXJlSW5saW5lRG9jcyhkYXRhKSB7XG5cbiAgcmV0dXJuIGRhdGFcbiAgICAucmVwbGFjZSgvQHBhcmFtLywgJzxzcGFuIGNsYXNzPVwiZG9jLXBhcmFtLWZpcnN0XCI+QHBhcmFtPC9zcGFuPicpXG4gICAgLnJlcGxhY2UoL0BwYXJhbS9nLCAnPHNwYW4gY2xhc3M9XCJ0ZXh0LWluZm8gZG9jLXBhcmFtXCI+QHBhcmFtPC9zcGFuPicpXG4gICAgLnJlcGxhY2UoL0ByZXR1cm4vLCAnPHNwYW4gY2xhc3M9XCJ0ZXh0LWluZm8gZG9jLXJldHVyblwiPkByZXR1cm48L3NwYW4+JylcbiAgICA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZERpc3BsYXlUZXh0KHBhcmFtcywgbmFtZSkge1xuXG4gIGlmIChwYXJhbXMubGVuZ3RoID09PSAwKSB7XG5cbiAgICByZXR1cm4gYCR7bmFtZX0oKWA7XG4gIH1cblxuICBjb25zdCBzdWdnZXN0aW9uUGFyYW1zID0gcGFyYW1zLm1hcChwYXJhbSA9PiB7XG5cbiAgICBwYXJhbSA9IHBhcmFtLnJlcGxhY2UoJ30nLCAnXFxcXH0nKTtcbiAgICBwYXJhbSA9IHBhcmFtLnJlcGxhY2UoLydcIi9nLCAnJyk7XG5cbiAgICByZXR1cm4gcGFyYW07XG4gIH0pO1xuXG4gIHJldHVybiBgJHtuYW1lfSgke3N1Z2dlc3Rpb25QYXJhbXMuam9pbignLCcpfSlgO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTbmlwcGV0KHBhcmFtcywgbmFtZSkge1xuXG4gIGNvbnN0IHN1Z2dlc3Rpb25QYXJhbXMgPSBwYXJhbXMubWFwKChwYXJhbSwgaSkgPT4ge1xuXG4gICAgcGFyYW0gPSBwYXJhbS5yZXBsYWNlKCd9JywgJ1xcXFx9Jyk7XG5cbiAgICByZXR1cm4gYFxcJHske2kgKyAxfToke3BhcmFtfX1gO1xuICB9KTtcblxuICByZXR1cm4gYCR7bmFtZX0oJHtzdWdnZXN0aW9uUGFyYW1zLmpvaW4oJywnKX0pYDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3RQYXJhbXModHlwZSkge1xuXG4gIGlmICghdHlwZSB8fCB0eXBlLnN0YXJ0c1dpdGgoJ2ZuKCknKSkge1xuXG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3QgcGFyYW1zID0gW107XG4gIGxldCBzdGFydCA9IHR5cGUuaW5kZXhPZignKCcpICsgMTtcbiAgbGV0IGluc2lkZSA9IDA7XG5cbiAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgdHlwZS5sZW5ndGg7IGkrKykge1xuXG4gICAgaWYgKHR5cGVbaV0gPT09ICc6JyAmJiBpbnNpZGUgPT09IC0xKSB7XG5cbiAgICAgIHBhcmFtcy5wdXNoKHR5cGUuc3Vic3RyaW5nKHN0YXJ0LCBpIC0gMikpO1xuXG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBpZiAoaSA9PT0gdHlwZS5sZW5ndGggLSAxKSB7XG5cbiAgICAgIGNvbnN0IHBhcmFtID0gdHlwZS5zdWJzdHJpbmcoc3RhcnQsIGkpO1xuXG4gICAgICBpZiAocGFyYW0ubGVuZ3RoKSB7XG5cbiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pO1xuICAgICAgfVxuXG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBpZiAodHlwZVtpXSA9PT0gJywnICYmIGluc2lkZSA9PT0gMCkge1xuXG4gICAgICBwYXJhbXMucHVzaCh0eXBlLnN1YnN0cmluZyhzdGFydCwgaSkpO1xuICAgICAgc3RhcnQgPSBpICsgMTtcblxuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVbaV0ubWF0Y2goL1t7XFxbXFwoXS8pKSB7XG5cbiAgICAgIGluc2lkZSsrO1xuXG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAodHlwZVtpXS5tYXRjaCgvW31cXF1cXCldLykpIHtcblxuICAgICAgaW5zaWRlLS07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBhcmFtcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFR5cGVDb21wbGV0aW9uKG9iaiwgaXNQcm9wZXJ0eSwgaXNPYmplY3RLZXksIGlzSW5GdW5EZWYpIHtcblxuICBpZiAob2JqLmlzS2V5d29yZCkge1xuXG4gICAgb2JqLl90eXBlU2VsZiA9ICdrZXl3b3JkJztcbiAgfVxuXG4gIGlmIChvYmoudHlwZSA9PT0gJ3N0cmluZycpIHtcblxuICAgIG9iai5uYW1lID0gb2JqLm5hbWUgPyBvYmoubmFtZS5yZXBsYWNlKC8oXlwifFwiJCkvZywgJycpIDogbnVsbDtcblxuICB9IGVsc2Uge1xuXG4gICAgb2JqLm5hbWUgPSBvYmoubmFtZSA/IG9iai5uYW1lLnJlcGxhY2UoL1tcIiddL2csICcnKSA6IG51bGw7XG4gIH1cblxuICBvYmoubmFtZSA9IG9iai5uYW1lID8gb2JqLm5hbWUucmVwbGFjZSgvXi4uP1xcLy8sICcnKSA6IG51bGw7XG5cbiAgaWYgKCFvYmoudHlwZSkge1xuXG4gICAgb2JqLl9kaXNwbGF5VGV4dCA9IG9iai5uYW1lO1xuICAgIG9iai5fc25pcHBldCA9IG9iai5uYW1lO1xuXG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIGlmICghb2JqLnR5cGUuc3RhcnRzV2l0aCgnZm4nKSkge1xuXG4gICAgaWYgKGlzUHJvcGVydHkpIHtcblxuICAgICAgb2JqLl90eXBlU2VsZiA9ICdwcm9wZXJ0eSc7XG5cbiAgICB9IGVsc2Uge1xuXG4gICAgICBvYmouX3R5cGVTZWxmID0gJ3ZhcmlhYmxlJztcbiAgICB9XG4gIH1cblxuICBvYmoudHlwZSA9IG9iai5yaWdodExhYmVsID0gcHJlcGFyZVR5cGUob2JqKTtcblxuICBpZiAob2JqLnR5cGUucmVwbGFjZSgvZm5cXCguK1xcKS8sICcnKS5sZW5ndGggPT09IDApIHtcblxuICAgIG9iai5sZWZ0TGFiZWwgPSAnJztcblxuICB9IGVsc2Uge1xuXG4gICAgaWYgKG9iai50eXBlLmluZGV4T2YoJ2ZuJykgPT09IC0xKSB7XG5cbiAgICAgIG9iai5sZWZ0TGFiZWwgPSBvYmoudHlwZTtcblxuICAgIH0gZWxzZSB7XG5cbiAgICAgIG9iai5sZWZ0TGFiZWwgPSBvYmoudHlwZS5yZXBsYWNlKC9mblxcKC57MCx9XFwpLywgJycpLnJlcGxhY2UoJyA6ICcsICcnKTtcbiAgICB9XG4gIH1cblxuICBpZiAob2JqLnJpZ2h0TGFiZWwuc3RhcnRzV2l0aCgnZm4nKSkge1xuXG4gICAgY29uc3QgcGFyYW1zID0gZXh0cmFjdFBhcmFtcyhvYmoucmlnaHRMYWJlbCk7XG4gICAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG4gICAgY29uc3QgYnVmZmVyUG9zaXRpb24gPSBjdXJzb3IuZ2V0QnVmZmVyUG9zaXRpb24oKTtcbiAgICBjb25zdCBidWZmZXJQb3NpdGlvbkZvbGxvd2luZyA9IFtidWZmZXJQb3NpdGlvbi5yb3csIGJ1ZmZlclBvc2l0aW9uLmNvbHVtbiArIDFdO1xuICAgIGNvbnN0IGNoYXJGb2xsb3dpbmcgPSBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoW2J1ZmZlclBvc2l0aW9uLCBidWZmZXJQb3NpdGlvbkZvbGxvd2luZ10pO1xuICAgIGNvbnN0IHNob3VsZEFkZFBhcmVudGhlc2VzVG9TbmlwcGV0ID0gY2hhckZvbGxvd2luZyAhPT0gJygnO1xuXG4gICAgaWYgKFxuICAgICAgcGFja2FnZUNvbmZpZy5vcHRpb25zLnVzZVNuaXBwZXRzIHx8XG4gICAgICBwYWNrYWdlQ29uZmlnLm9wdGlvbnMudXNlU25pcHBldHNBbmRGdW5jdGlvblxuICAgICkge1xuXG4gICAgICBpZiAoIWlzSW5GdW5EZWYpIHtcblxuICAgICAgICBpZiAocGFyYW1zLmxlbmd0aCA9PT0gMCkge1xuXG4gICAgICAgICAgb2JqLl9zbmlwcGV0ID0gYCR7b2JqLm5hbWV9JHtzaG91bGRBZGRQYXJlbnRoZXNlc1RvU25pcHBldCA/ICcoKScgOiAnJ31gO1xuXG4gICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICBvYmouX3NuaXBwZXQgPSBidWlsZFNuaXBwZXQocGFyYW1zLCBvYmoubmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgb2JqLl9oYXNQYXJhbXMgPSBwYXJhbXMubGVuZ3RoID8gdHJ1ZSA6IGZhbHNlO1xuXG4gICAgfSBlbHNlIHtcblxuICAgICAgaWYgKCFpc0luRnVuRGVmKSB7XG5cbiAgICAgICAgb2JqLl9zbmlwcGV0ID0gcGFyYW1zLmxlbmd0aCA/IGAke29iai5uYW1lfShcXCR7JHswfTpcXCR7fX0pYCA6IGAke29iai5uYW1lfSR7c2hvdWxkQWRkUGFyZW50aGVzZXNUb1NuaXBwZXQgPyAnKCknIDogJyd9YDtcbiAgICAgIH1cblxuICAgICAgb2JqLl9kaXNwbGF5VGV4dCA9IGJ1aWxkRGlzcGxheVRleHQocGFyYW1zLCBvYmoubmFtZSk7XG4gICAgfVxuXG4gICAgb2JqLl90eXBlU2VsZiA9ICdmdW5jdGlvbic7XG4gIH1cblxuICBpZiAob2JqLm5hbWUpIHtcblxuICAgIGlmIChvYmoubGVmdExhYmVsID09PSBvYmoubmFtZSkge1xuXG4gICAgICBvYmoubGVmdExhYmVsID0gbnVsbDtcbiAgICAgIG9iai5yaWdodExhYmVsID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBpZiAob2JqLmxlZnRMYWJlbCA9PT0gb2JqLnJpZ2h0TGFiZWwpIHtcblxuICAgIG9iai5yaWdodExhYmVsID0gbnVsbDtcbiAgfVxuXG4gIHJldHVybiBvYmo7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkaXNwb3NlQWxsKGRpc3Bvc2FibGVzKSB7XG5cbiAgZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IGRpc3Bvc2FibGUuZGlzcG9zZSgpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5GaWxlQW5kR29Ub1Bvc2l0aW9uKHBvc2l0aW9uLCBmaWxlKSB7XG5cbiAgYXRvbS53b3Jrc3BhY2Uub3BlbihmaWxlKS50aGVuKCh0ZXh0RWRpdG9yKSA9PiB7XG5cbiAgICBjb25zdCBjdXJzb3IgPSB0ZXh0RWRpdG9yLmdldExhc3RDdXJzb3IoKTtcblxuICAgIGlmICghY3Vyc29yKSB7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjdXJzb3Iuc2V0QnVmZmVyUG9zaXRpb24ocG9zaXRpb24pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5GaWxlQW5kR29UbyhzdGFydCwgZmlsZSkge1xuXG4gIGF0b20ud29ya3NwYWNlLm9wZW4oZmlsZSkudGhlbigodGV4dEVkaXRvcikgPT4ge1xuXG4gICAgY29uc3QgYnVmZmVyID0gdGV4dEVkaXRvci5nZXRCdWZmZXIoKTtcbiAgICBjb25zdCBjdXJzb3IgPSB0ZXh0RWRpdG9yLmdldExhc3RDdXJzb3IoKTtcblxuICAgIGlmIChcbiAgICAgICFidWZmZXIgfHxcbiAgICAgICFjdXJzb3JcbiAgICApIHtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGJ1ZmZlclBvc2l0aW9uID0gYnVmZmVyLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoc3RhcnQpO1xuXG4gICAgY3Vyc29yLnNldEJ1ZmZlclBvc2l0aW9uKGJ1ZmZlci5wb3NpdGlvbkZvckNoYXJhY3RlckluZGV4KHN0YXJ0KSk7XG5cbiAgICBuYXZpZ2F0aW9uLmFwcGVuZCh0ZXh0RWRpdG9yLCBidWZmZXIsIGJ1ZmZlclBvc2l0aW9uKTtcblxuICAgIG1hcmtEZWZpbml0aW9uQnVmZmVyUmFuZ2UoY3Vyc29yLCB0ZXh0RWRpdG9yKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVUZXJuRmlsZShjb250ZW50KSB7XG5cbiAgY29uc3QgcHJvamVjdFJvb3QgPSBtYW5hZ2VyLnNlcnZlciAmJiBtYW5hZ2VyLnNlcnZlci5wcm9qZWN0RGlyO1xuXG4gIGlmICghcHJvamVjdFJvb3QpIHtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIHdyaXRlRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBwcm9qZWN0Um9vdCArICcvLnRlcm4tcHJvamVjdCcpLCBjb250ZW50KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlUGF0aCwgY29udGVudCkge1xuXG4gIGZzLndyaXRlRmlsZShmaWxlUGF0aCwgY29udGVudCwgKGVycm9yKSA9PiB7XG5cbiAgICBhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGVQYXRoKTtcblxuICAgIGlmICghZXJyb3IpIHtcblxuICAgICAgY29uc3Qgc2VydmVyID0gbWFuYWdlci5zZXJ2ZXI7XG4gICAgICBzZXJ2ZXIgJiYgc2VydmVyLnJlc3RhcnQoKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IG1lc3NhZ2UgPSAnQ291bGQgbm90IGNyZWF0ZS91cGRhdGUgLnRlcm4tcHJvamVjdCBmaWxlLiBVc2UgdGhlIFJFQURNRSB0byBtYW51YWxseSBjcmVhdGUgYSAudGVybi1wcm9qZWN0IGZpbGUuJztcblxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKG1lc3NhZ2UsIHtcblxuICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICB9KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0RpcmVjdG9yeShkaXIpIHtcblxuICB0cnkge1xuXG4gICAgcmV0dXJuIGZzLnN0YXRTeW5jKGRpcikuaXNEaXJlY3RvcnkoKTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWxlRXhpc3RzKHBhdGgpIHtcblxuICB0cnkge1xuXG4gICAgZnMuYWNjZXNzU3luYyhwYXRoLCBmcy5GX09LLCAoZXJyb3IpID0+IHtcblxuICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZUNvbnRlbnQoZmlsZVBhdGgsIHJvb3QpIHtcblxuICBjb25zdCBfZmlsZVBhdGggPSByb290ICsgZmlsZVBhdGg7XG4gIGNvbnN0IHJlc29sdmVkUGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIF9maWxlUGF0aCk7XG5cbiAgaWYgKGZpbGVFeGlzdHMocmVzb2x2ZWRQYXRoKSAhPT0gdW5kZWZpbmVkKSB7XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gcmVhZEZpbGUocmVzb2x2ZWRQYXRoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRGaWxlKHBhdGgpIHtcblxuICB0cnkge1xuXG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmOCcpO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFya0RlZmluaXRpb25CdWZmZXJSYW5nZShjdXJzb3IsIGVkaXRvcikge1xuXG4gIGNvbnN0IHJhbmdlID0gY3Vyc29yLmdldEN1cnJlbnRXb3JkQnVmZmVyUmFuZ2UoKTtcbiAgY29uc3QgbWFya2VyID0gZWRpdG9yLm1hcmtCdWZmZXJSYW5nZShyYW5nZSwge2ludmFsaWRhdGU6ICd0b3VjaCd9KTtcblxuICBjb25zdCBkZWNvcmF0aW9uID0gZWRpdG9yLmRlY29yYXRlTWFya2VyKG1hcmtlciwge1xuXG4gICAgdHlwZTogJ2hpZ2hsaWdodCcsXG4gICAgY2xhc3M6ICdhdG9tLXRlcm5qcy1kZWZpbml0aW9uLW1hcmtlcicsXG4gICAgaW52YWxpZGF0ZTogJ3RvdWNoJ1xuICB9KTtcblxuICBpZiAoIWRlY29yYXRpb24pIHtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgZGVjb3JhdGlvbi5zZXRQcm9wZXJ0aWVzKHtcblxuICAgICAgdHlwZTogJ2hpZ2hsaWdodCcsXG4gICAgICBjbGFzczogJ2F0b20tdGVybmpzLWRlZmluaXRpb24tbWFya2VyIGFjdGl2ZScsXG4gICAgICBpbnZhbGlkYXRlOiAndG91Y2gnXG4gICAgfSk7XG5cbiAgfSwgMSk7XG5cbiAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICBkZWNvcmF0aW9uLnNldFByb3BlcnRpZXMoe1xuXG4gICAgICB0eXBlOiAnaGlnaGxpZ2h0JyxcbiAgICAgIGNsYXNzOiAnYXRvbS10ZXJuanMtZGVmaW5pdGlvbi1tYXJrZXInLFxuICAgICAgaW52YWxpZGF0ZTogJ3RvdWNoJ1xuICAgIH0pO1xuXG4gIH0sIDE1MDEpO1xuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgbWFya2VyLmRlc3Ryb3koKTtcblxuICB9LCAyNTAwKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFBhY2thZ2VQYXRoKCkge1xuXG4gIGNvbnN0IHBhY2thZ1BhdGggPSBhdG9tLnBhY2thZ2VzLnJlc29sdmVQYWNrYWdlUGF0aCgnYXRvbS10ZXJuanMnKTtcblxuICByZXR1cm4gcGFja2FnUGF0aDtcbn1cbiJdfQ==